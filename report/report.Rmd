---
title: "titanic_report"
author: "alpgu Gunsever"
date: "13/01/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 1 - Introduction 

This is a data analysis report intended to test bayesian data analysis skills using the titanic dataset from kaggle.

```{r libraries}
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
library(shinystan)
library(stringr)
#source(file.path("C:","Users","alpgu","Dropbox","Data Science","Bayesian Data Analysis","BDA3 (Gelman)","titanic","scripts","helperFunctions_temp.R"))
library(corrplot)
library(rstanarm)
library(projpred)
library(bayesplot)
library(mice)
library(VIM)
library(ggplot2)
theme_set(bayesplot::theme_default(base_family = "sans"))
library(dplyr)
library(gridExtra)
```

## 2- Exploratory Data Analysis

We are first going to make an exploratory analysis on the data available at hand. We format the data beforehand in both training and test sets.

The existing observations for different predictors will be formatted into data structures that can be handled by R in a meaningful way. 

```{r clean data}
# read train and test data
dir <- file.path("C:","Users","alpgu","Dropbox","Data Science","Bayesian Data Analysis","BDA3 (Gelman)","titanic","data")
dat.train <- read.csv(file.path(dir,"train.csv"))
dat.test <- read.csv(file.path(dir,"test.csv"))

# combine train and test data for cleaning
dat.train_without_survival <- cbind(data.frame(PassengerId=dat.train[,1]),dat.train[,3:length(colnames(dat.train))])
dat.full <- rbind(dat.train_without_survival, dat.test)

# adjustments on data set

# factorize Pclass variable
dat.full$Pclass <- as.factor(dat.full$Pclass)

# extract titles from names
dat.full$title <- str_split_fixed(as.character(str_split_fixed(dat.full$Name, ",", 2)[,2]),". ",2)[,1]
dat.full$title <- gsub(" ", "", dat.full$title, fixed = TRUE)
dat.full$title[760] <- "Countess"
for (i in 1:length(dat.full$title)){
  if(grepl("Mr|Mrs|Miss|Master",dat.full$title[i]) == F){
    if(grepl("Countess|Sir|Lady|Don",dat.full$title[i]) == T){
      dat.full$title[i] <- "Noble"
    }
    else if(grepl("Capt|Col|Major",dat.full$title[i]) == T){
      dat.full$title[i] <- "Soldier"
    } 
    else{
      if(dat.full$Sex[i] == "male"){
        dat.full$title[i] <- "Mr"  
      } else{
        dat.full$title[i] <- "Miss"
      }
        
    }
  } 
}
dat.full$title <- as.factor(dat.full$title)

# factorize cabin variable according to letter
dat.full$Cabin <-sapply(dat.full$Cabin, function(x) substr(x,1,1))
dat.full$Cabin[dat.full$Cabin==""] <- NA
dat.full$Cabin <- as.factor(dat.full$Cabin)

# factorize embarked variable according to letter
dat.full$Embarked[dat.full$Embarked==""] <- NA
dat.full$Embarked <- as.factor(dat.full$Embarked)

# reduce factor size of ticket variable
dat.full$Ticket <- as.character(dat.full$Ticket)
dat.full$Ticket[grepl("L",dat.full$Ticket) == TRUE] <- "L"
dat.full$Ticket[grepl("F",dat.full$Ticket) == TRUE] <- "F"
dat.full$Ticket[grepl("PC|P",dat.full$Ticket) == TRUE] <- "P"
dat.full$Ticket[grepl("CA|C.A.|CA.|C ",dat.full$Ticket) == TRUE] <- "C"
dat.full$Ticket[grepl("A/5|A/5.|A.5.|A./5.|A/4.|A4.|A|A.|AQ",dat.full$Ticket) == TRUE] <- "A"
dat.full$Ticket[grepl("S",dat.full$Ticket) == TRUE] <- "S"
dat.full$Ticket[grepl("W",dat.full$Ticket) == TRUE] <- "W"
dat.full$Ticket <- sapply(dat.full$Ticket, function(x) ifelse(nchar(x)>1,as.character(nchar(x)),x))
dat.full$Ticket <- as.factor(dat.full$Ticket)

# Create family size variable including the passenger itself
dat.full <- transform(dat.full, 'familySize' =  SibSp + Parch +1)
dat.full <- dat.full[ , -which(names(dat.full) %in% c("SibSp","Parch"))]
dat.full$fSize <- NA
dat.full$fSize[dat.full$familySize == 1] <- 'singleton'
dat.full$fSize[dat.full$familySize <= 4 & dat.full$familySize > 1] <- 'small'
dat.full$fSize[dat.full$familySize > 4] <- 'large'
dat.full <- dat.full[ , -which(names(dat.full) %in% c("familySize"))]
dat.full$fSize <- as.factor(dat.full$fSize)

# Change sex variable to more understandable isMale variable
dat.full$isMale <- NA
dat.full$isMale[dat.full$Sex == "male"] <- 1
dat.full$isMale[dat.full$Sex <= "female"] <- 0
dat.full$isMale <- as.factor(dat.full$isMale)
dat.full <- dat.full[ , -which(names(dat.full) %in% c("Sex"))]

# Deleting the names variable
dat.full <- dat.full[ , -which(names(dat.full) %in% c("Name"))]
```

After getting rid of spaces in the character values and factorizing them as well as transforming the numerical variables, now let's look at the data summary.

```{r data summary}
summary(dat.full)
str(dat.full)
```

Cabin and age predictors have a lot of missing observations so it can be beneficial to get rid of these predictors but we will also be losing a lot of information so it makes sense to further investigate if imputation is possible.

```{r visual check with available data1}
dat.full.train <- data.frame(Survived = as.factor(dat.train[,2]),dat.full[1:891,])
g <- ggplot()
title_avAge <- dat.full.train %>% group_by(title) %>% summarise(n=n(),avAge = mean(Age, na.rm = T), 
                                                                medAge = median(Age,na.rm=T))
p1 <- g + geom_col(data = title_avAge,aes(x=title,y=avAge),fill = "deepskyblue3")
p2 <- g + geom_col(data = title_avAge,aes(x=title,y=n),fill = "salmon3")
grid.arrange(p1,p2, ncol=2)

survtitle1 <- g + geom_bar(data = dat.full.train, aes(x=title, fill = Survived), position = "stack")
survtitle2 <- g + geom_bar(data = dat.full.train, aes(x=title, fill = Survived), position = "fill")
grid.arrange(survtitle1,survtitle2, ncol=2)

ticket_avFare <- dat.full.train %>% group_by(Ticket) %>% summarise(n=n(),avFare = mean(Fare, na.rm = T))
g + geom_col(data = ticket_avFare,aes(x=Ticket,y=avFare),fill = "deepskyblue3")

survClass1 <- g + geom_bar(data = dat.full.train, aes(x=Pclass, fill = Survived), position = "stack")
survClass2 <- g + geom_bar(data = dat.full.train, aes(x=Pclass, fill = Survived), position = "fill")
grid.arrange(survClass1,survClass2, ncol=2)

Pclass_avFare <- dat.full.train %>% group_by(Pclass) %>% summarise(n=n(),avFare = mean(Fare, na.rm = T))
g + geom_col(data = Pclass_avFare,aes(x=Pclass,y=avFare),fill = "deepskyblue3")

survCabin1 <- g + geom_bar(data = dat.full.train, aes(x=Cabin, fill = Survived), position = "stack")
survCabin2 <- g + geom_bar(data = dat.full.train, aes(x=Cabin, fill = Survived), position = "fill")
grid.arrange(survCabin1,survCabin2, ncol=2)

survTicket1 <- g + geom_bar(data = dat.full.train, aes(x=Ticket, fill = Survived), position = "stack")
survTicket2 <- g + geom_bar(data = dat.full.train, aes(x=Ticket, fill = Survived), position = "fill")
grid.arrange(survTicket1,survTicket2, ncol=2)

g + geom_bar(data = dat.full.train, aes(x=Pclass, fill = Cabin), position = "stack")
g + geom_bar(data = dat.full.train, aes(x=Ticket, fill = Cabin), position = "stack")
g + geom_bar(data = dat.full.train, aes(x=Pclass, fill = Ticket), position = "stack")

survfSize1 <- g + geom_bar(data = dat.full.train, aes(x=fSize, fill = Survived), position = "stack")
survfSize2 <- g + geom_bar(data = dat.full.train, aes(x=fSize, fill = Survived), position = "fill")
grid.arrange(survfSize1,survfSize2, ncol=2)

survEmbarked1 <- g + geom_bar(data = dat.full.train, aes(x=Embarked, fill = Survived), position = "stack")
survEmbarked2 <- g + geom_bar(data = dat.full.train, aes(x=Embarked, fill = Survived), position = "fill")
grid.arrange(survEmbarked1,survEmbarked2, ncol=2)
```

We will impute the missing age observations by replacing them with median of each title that the idividual belongs to.

```{r visual check with available data2}
for (i in 1:length(dat.full$Age)){
  if(is.na(dat.full$Age[i])==T){
    if(dat.full$title[i] == "Master") dat.full$Age[i] = title_avAge[1,4]
    if(dat.full$title[i] == "Miss") dat.full$Age[i] = title_avAge[2,4]
    if(dat.full$title[i] == "Mr") dat.full$Age[i] = title_avAge[3,4]
    if(dat.full$title[i] == "Mrs") dat.full$Age[i] = title_avAge[4,4]
    if(dat.full$title[i] == "Noble") dat.full$Age[i] = title_avAge[5,4]
    if(dat.full$title[i] == "Soldier") dat.full$Age[i] = title_avAge[6,4]
  }
}

# Create discrete variable out of discrete numeric variable age
dat.full$ageG[dat.full$Age <25] <- 'young'
dat.full$ageG[dat.full$Age < 60 & dat.full$Age >= 25] <- 'middleAged'
dat.full$ageG[dat.full$Age >= 60] <- 'old'
dat.full$ageG <- as.factor(dat.full$ageG)

dat.full.train <- data.frame(Survived = as.factor(dat.train[,2]),dat.full[1:891,])
survageG1 <- g + geom_bar(data = dat.full.train, aes(x=ageG, fill = Survived), position = "stack")
survageG2 <- g + geom_bar(data = dat.full.train, aes(x=ageG, fill = Survived), position = "fill")
grid.arrange(survageG1,survageG2, ncol=2)
```

Individuals that are upper class passengers, are members of small families, embarked from C and are not old tend to have higher survival rates. 

Cabin variable will be dropped as it doesn't seem possible to impute this predictor with lots of missing observations. However, it might still makes sense to impute age predictor and create a factorized variable out of the discrete numeric variable.

```{r missing data}
dat.full <- dat.full[ , !(names(dat.full) %in% c("Cabin","Age"))]
md.pattern(dat.full, rotate.names = TRUE)

imp_full <- mice(dat.full, m = 20, maxit = 40,printFlag = FALSE)
summary(imp_full)
imp_full$method
plot(imp_full)
dat.full_imp <- complete(imp_full)

# Log transform continuous fare variabÃ¦e
dat.full_imp$FareLog <- log(dat.full_imp$Fare+1) # 1 added to avoid log(0)
dat.full_imp <- dat.full_imp[ , -which(names(dat.full_imp) %in% c("Fare"))]

train_imp <- data.frame(PassengerId = dat.full_imp[1:891,1], Survived = as.factor(dat.train[,2]), dat.full_imp[1:891,2:9])
test_imp <- dat.full_imp[892:1309,]
```

The imputed dataset will be used for analysis.

```{r input for rstanarm model1}
y.train <- as.numeric(train_imp$Survived) # outcome
y.train <- y.train-1
pId.train <- train_imp$PassengerId # ID for predictions
pId.test <- test_imp$PassengerId # ID for predictions

predictor1.variables <- colnames(train_imp)[3:length(colnames(train_imp))]
predictor1.variables <- predictor1.variables[predictor1.variables != "Pclass"]

X1 <- subset(train_imp, select=predictor1.variables)
X1.train <- model.matrix(y.train~., X1)[,-1] #drop int
X1 <- subset(test_imp, select=predictor1.variables)
X1.test <- model.matrix(~., X1)[,-1] #drop int

colnames(X1.train) <- gsub(" ", "", colnames(X1.train), fixed = TRUE)
colnames(X1.test) <- gsub(" ", "", colnames(X1.test), fixed = TRUE)

N1.train <- nrow(X1.train)
K1.train <- ncol(X1.train)
N1.test <- nrow(X1.test)
K1.test <- ncol(X1.test)

X1.train <- scale(X1.train)
X1.test <- scale(X1.test)

pClassTrain <- as.numeric(train_imp$Pclass)
pClassTest <- as.numeric(test_imp$Pclass)
```

## 3- Prior Predictive Checking

## 4 - Model Fitting and Algorithm Diagnostics
```{r model1 fitting}
# model 1: hierarchical grouped by pClass---------------------------------------------------------------
pClass <- pClassTrain 
df1.train <- as.data.frame(cbind(y.train, X1.train,pClass))
pClass <- pClassTest
df1.test <- as.data.frame(cbind(X1.test,pClass))

formula1 <- as.formula(paste("y.train ~", paste0("1+",paste(colnames(X1.train), collapse = "+")),"+(1+",paste(colnames(X1.train), collapse = "+"),"|pClass)"))

model1_fit_hier_pClass <- stan_glmer(formula = formula1,
                              data = df1.train, 
                              cores=4,
                              adapt_delta = 0.98,
                              algorithm = "sampling",
                              family = binomial(link = "logit"),
                              prior = student_t(7,0,2.5),
                              prior_intercept = student_t(7,0,2.5))
```

```{r model diagnostics}
summary(model1_fit_hier_pClass)
prior_summary(object = model1_fit_hier_pClass)

y_pred1.hier <- posterior_predict(model1_fit_hier_pClass, df1.test)
yrep1 <- posterior_predict(model1_fit_hier_pClass)

loo1.pred.hier <- loo(model1_fit_hier_pClass)

#loo_compare(loo1.pred.hier,loo2.pred.hier,loo3.pred.hier)

ppc_dens_overlay(y.train, yrep1)

#mcmc_areas(as.matrix(model1_fit_hier_ticket)[,1:19])
#mcmc_areas(as.matrix(model2_fit_hier_ticket)[,1:22])
```

## 5 - Posterior Predictive Checking

## 6 - Model Comparison

## 7 - Prediction Submission
```{r predictions model1}
probs1.hier <- apply(y_pred1.hier, 2, mean)
preds1.hier <- ifelse(probs1.hier > .5, 1, 0)

model1_hier.submission <- data.frame("PassengerId" = pId.test, "Survived" = preds1.hier)
write.csv(x = model1_hier.submission, file = file.path("C:","Users","alpgu","Dropbox","Data Science",                                             "Bayesian Data Analysis","BDA3 (Gelman)","titanic","submissions","model1_hier_pClass.csv"),
          row.names = FALSE)
```
