---
title: "titanic_report"
author: "Alp Gunsever"
date: "13/01/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 1 - Introduction 

This is a data analysis report intended to test bayesian data analysis skills using the titanic dataset from kaggle.

```{r libraries}
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
library(shinystan)
library(stringr)
source(file.path("C:","Users","Alp","Dropbox","Data Science","Bayesian Data Analysis","BDA3 (Gelman)","titanic","scripts","helperFunctions_temp.R"))
library(corrplot)
library(rstanarm)
library(projpred)
library(bayesplot)
library(mice)
library(VIM)
library(ggplot2)
theme_set(bayesplot::theme_default(base_family = "sans"))
```

## 2- Exploratory Data Analysis

We are first going to make an exploratory analysis on the data available at hand. We format the data beforehand in both training and test sets.

The existing observations for different predictors will be formatted into data structures that can be handled by R in a meaningful way. 

```{r clean data}
# read train and test data
dir <- file.path("C:","Users","Alp","Dropbox","Data Science","Bayesian Data Analysis","BDA3 (Gelman)","titanic","data")
dat.train <- read.csv(file.path(dir,"train.csv"))
dat.test <- read.csv(file.path(dir,"test.csv"))

# combine train and test data for cleaning
dat.train_without_survival <- cbind(data.frame(PassengerId=dat.train[,1]),dat.train[,3:length(colnames(dat.train))])
dat.full <- rbind(dat.train_without_survival, dat.test)

# adjustments on data set

# factorize Pclass variable
dat.full$Pclass <- as.factor(dat.full$Pclass)

# extract titles from names
dat.full$title <- str_split_fixed(as.character(str_split_fixed(dat.full$Name, ",", 2)[,2]),". ",2)[,1]
dat.full$title <- as.factor(dat.full$title)

# factorize cabin variable according to letter
dat.full$Cabin <-sapply(dat.full$Cabin, function(x) substr(x,1,1))
dat.full$Cabin[dat.full$Cabin==""] <- NA
dat.full$Cabin <- as.factor(dat.full$Cabin)

# factorize embarked variable according to letter
dat.full$Embarked[dat.full$Embarked==""] <- NA
dat.full$Embarked <- as.factor(dat.full$Embarked)

# reduce factor size of ticket variable
dat.full$Ticket <- as.character(dat.full$Ticket)
dat.full$Ticket[grepl("L",dat.full$Ticket) == TRUE] <- "L"
dat.full$Ticket[grepl("F",dat.full$Ticket) == TRUE] <- "F"
dat.full$Ticket[grepl("PC|P",dat.full$Ticket) == TRUE] <- "P"
dat.full$Ticket[grepl("CA|C.A.|CA.|C ",dat.full$Ticket) == TRUE] <- "C"
dat.full$Ticket[grepl("A/5|A/5.|A.5.|A./5.|A/4.|A4.|A|A.|AQ",dat.full$Ticket) == TRUE] <- "A"
dat.full$Ticket[grepl("S",dat.full$Ticket) == TRUE] <- "S"
dat.full$Ticket[grepl("W",dat.full$Ticket) == TRUE] <- "W"
dat.full$Ticket <- sapply(dat.full$Ticket, function(x) ifelse(nchar(x)>1,as.character(nchar(x)),x))
dat.full$Ticket <- as.factor(dat.full$Ticket)

# Create family size variable including the passenger itself
dat.full <- transform(dat.full, 'fSize' =  SibSp + Parch +1)
dat.full <- dat.full[ , -which(names(dat.full) %in% c("SibSp","Parch"))]

# Change sex variable to more understandable isMale variable
dat.full$isMale <- NA
dat.full$isMale[dat.full$Sex == "male"] <- 1
dat.full$isMale[dat.full$Sex <= "female"] <- 0
dat.full$isMale <- as.factor(dat.full$isMale)
dat.full <- dat.full[ , -which(names(dat.full) %in% c("Sex"))]

# creating surnames variable from names variable and deleting the names variable
surnames <- str_split_fixed(dat.full$Name, ",", 2)[,1]
cat_surnames <- as.factor(surnames)
dat.full$surnames <- cat_surnames
dat.full <- dat.full[ , -which(names(dat.full) %in% c("Name"))]
```

After getting rid of spaces in the character values and factorizing them as well as transforming the numerical variables, now let's look at the data summary.

```{r data summary}
summary(dat.full)
str(dat.full)
```

Cabin and age predictors have a lot of missing observations so it might make sense to get rid of these predictors but we will also be losing a lot of information so it makes sense to further investigate if imputation is possible. The first idea that comes to mind about cabin predictor is to check surnames to see if imputation can be partially possible.

```{r visual check with available data}

```

```{r check surnames for cabin}
surnames <- str_split_fixed(dat.train$Name, ",", 2)[,1]
cat_surnames <- as.factor(surnames)
cat_cabin <- as.factor(dat.train$Cabin)
summary(cat_surnames)

surnames_cabin <- data.frame(names = dat.train$Name,siblingsSpouses = dat.train$SibSp,parentsChildren=dat.train$Parch,
                             surnames = cat_surnames,cabin = cat_cabin,fare = dat.train$Fare,pClass = dat.train$Pclass)
surnames_cabin <- surnames_cabin[order(surnames_cabin$surnames),]
plot(dat.train$Pclass,dat.train$Fare/(dat.train$SibSp+dat.train$Parch))
```

It can be seen from the created sub data set that it is not possible to predict the cabin type by using surnames because of huge amount of missing data. However, it can also be seen that using surnames to make a new variable can be as useful compared to using the cabin variable as the correlation between the survivalability of the same family members can be expected to be high. The advantage of the cabin type would be to correlate with the location on the ship which is a determinng factor for survivability. 

We will use mice package for imputing the training and the test sets.

```{r missing data}
md.pattern(train, rotate.names = TRUE)
md.pattern(test, rotate.names = TRUE)

train <- train[ , !(names(train) %in% c("Cabin","AgeLog"))]
test <- test[ , !(names(test) %in% c("Cabin","AgeLog"))]

imp_train <- mice(train, maxit = 40,printFlag = FALSE)
summary(imp_train)
imp_train$method
plot(imp_train)
densityplot(imp_train, ~ Embarked)
stripplot(imp_train, Embarked ~ .imp, pch = 20, cex = 2)
train_imp <- complete(imp_train)

imp_test <- mice(test, maxit = 40,printFlag = FALSE)
summary(imp_test)
imp_test$method
plot(imp_test)
stripplot(imp_test, FareLog ~ .imp, pch = 20, cex = 2)
test_imp <- complete(imp_test)
```


```{r data visualizations}
#Extract numeric variables
num_var_names <- colnames(train)[sapply(train[,colnames(train)],class) %in% c("numeric","integer")]
train_num <- train[,num_var_names]

#Extract categorical variables
cat_var_names <- colnames(train)[sapply(train[,colnames(train)],class) %in% c("factor","character")]
train_cat <- train[,cat_var_names]
```



```{r input for rstanarm model1}
y.train <- as.numeric(train_imp$Survived) # outcome
y.train <- y.train-1
pId.train <- train_imp$PassengerId # ID for predictions
pId.test <- test_imp$PassengerId # ID for predictions

predictor1.variables <- colnames(train_imp)[3:length(colnames(train_imp))]
predictor1.variables <- predictor1.variables[predictor1.variables != "Ticket"]
predictor2.variables <- colnames(train_imp)[3:length(colnames(train_imp))]
predictor2.variables <- predictor2.variables[predictor2.variables != "title"]
predictor3.variables <- colnames(train_imp)[3:length(colnames(train_imp))]
predictor3.variables <- predictor3.variables[predictor3.variables != "Pclass"]

X1 <- subset(train_imp, select=predictor1.variables)
X1.train <- model.matrix(y.train~., X1)[,-1] #drop int
X1 <- subset(test_imp, select=predictor1.variables)
X1.test <- model.matrix(~., X1)[,-1] #drop int

X2 <- subset(train_imp, select=predictor2.variables)
X2.train <- model.matrix(y.train~., X2)[,-1] #drop int
X2 <- subset(test_imp, select=predictor2.variables)
X2.test <- model.matrix(~., X2)[,-1] #drop int

X3 <- subset(train_imp, select=predictor3.variables)
X3.train <- model.matrix(y.train~., X3)[,-1] #drop int
X3 <- subset(test_imp, select=predictor3.variables)
X3.test <- model.matrix(~., X3)[,-1] #drop int

colnames(X1.train) <- gsub(" ", "", colnames(X1.train), fixed = TRUE)
colnames(X1.test) <- gsub(" ", "", colnames(X1.test), fixed = TRUE)

colnames(X2.train) <- gsub(" ", "", colnames(X2.train), fixed = TRUE)
colnames(X2.test) <- gsub(" ", "", colnames(X2.test), fixed = TRUE)

colnames(X3.train) <- gsub(" ", "", colnames(X3.train), fixed = TRUE)
colnames(X3.test) <- gsub(" ", "", colnames(X3.test), fixed = TRUE)

N1.train <- nrow(X1.train)
K1.train <- ncol(X1.train)
N1.test <- nrow(X1.test)
K1.test <- ncol(X1.test)

N2.train <- nrow(X2.train)
K2.train <- ncol(X2.train)
N2.test <- nrow(X2.test)
K2.test <- ncol(X2.test)

N3.train <- nrow(X3.train)
K3.train <- ncol(X3.train)
N3.test <- nrow(X3.test)
K3.test <- ncol(X3.test)

for(i in 1:K1.train){
  if (colnames(X1.train)[i] != 'AgeLog' & colnames(X1.train)[i] != 'FareLog') {
    X1.train[,i] <- scale(X1.train[,i], scale = F)
  } else{
    X1.train[,i] <- (X1.train[,i]-mean(X1.train[,i]))/(2*sd(X1.train[,i]))
  }
}

for(i in 1:K1.test){
  if (colnames(X1.test)[i] != 'AgeLog' & colnames(X1.test)[i] != 'FareLog') {
    X1.test[,i] <- scale(X1.test[,i], scale = F)
  } else{
    X1.test[,i] <- (X1.test[,i]-mean(X1.test[,i]))/(2*sd(X1.test[,i]))
  }
}

for(i in 1:K2.train){
  if (colnames(X2.train)[i] != 'AgeLog' & colnames(X2.train)[i] != 'FareLog') {
    X2.train[,i] <- scale(X2.train[,i], scale = F)
  } else{
    X2.train[,i] <- (X2.train[,i]-mean(X2.train[,i]))/(2*sd(X2.train[,i]))
  }
}

for(i in 1:K2.test){
  if (colnames(X2.test)[i] != 'AgeLog' & colnames(X2.test)[i] != 'FareLog') {
    X2.test[,i] <- scale(X2.test[,i], scale = F)
  } else{
    X2.test[,i] <- (X2.test[,i]-mean(X2.test[,i]))/(2*sd(X2.test[,i]))
  }
}

for(i in 1:K3.train){
  if (colnames(X3.train)[i] != 'AgeLog' & colnames(X3.train)[i] != 'FareLog') {
    X3.train[,i] <- scale(X3.train[,i], scale = F)
  } else{
    X3.train[,i] <- (X3.train[,i]-mean(X3.train[,i]))/(2*sd(X3.train[,i]))
  }
}

for(i in 1:K3.test){
  if (colnames(X3.test)[i] != 'AgeLog' & colnames(X3.test)[i] != 'FareLog') {
    X3.test[,i] <- scale(X3.test[,i], scale = F)
  } else{
    X3.test[,i] <- (X3.test[,i]-mean(X3.test[,i]))/(2*sd(X3.test[,i]))
  }
}

ticketTrain <- as.numeric(train_imp$Ticket)
ticketTest <- as.numeric(test_imp$Ticket)

titleTrain <- as.numeric(train_imp$title)
titleTest <- as.numeric(test_imp$title)

pClassTrain <- as.numeric(train_imp$Pclass)
pClassTest <- as.numeric(test_imp$Pclass)
```

## 3- Prior Predictive Checking

## 4 - Model Fitting and Algorithm Diagnostics
```{r model1 fitting}
# model 1: hierarchical grouped by ticket---------------------------------------------------------------
ticket <- ticketTrain 
df1.train <- as.data.frame(cbind(y.train, X1.train,ticket))
ticket <- ticketTest
df1.test <- as.data.frame(cbind(X1.test,ticket))

title <- titleTrain 
df2.train <- as.data.frame(cbind(y.train, X2.train,title))
title <- titleTest
df2.test <- as.data.frame(cbind(X2.test,title))

pClass <- pClassTrain 
df3.train <- as.data.frame(cbind(y.train, X3.train,pClass))
pClass <- pClassTest
df3.test <- as.data.frame(cbind(X3.test,pClass))

formula1 <- as.formula(paste("y.train ~", paste0("1+",paste(colnames(X1.train), collapse = "+")),"+(1+",paste(colnames(X1.train), collapse = "+"),"|ticket)"))

model1_fit_hier_ticket <- stan_glmer(formula = formula1,
                              data = df1.train, 
                              cores=4,
                              adapt_delta = 0.98,
                              algorithm = "sampling",
                              family = binomial(link = "logit"),
                              prior = student_t(7,0,2.5),
                              prior_intercept = student_t(7,0,2.5))

# model 2: hierarchical grouped by title----------------------------------------------------------------
formula2 <- as.formula(paste("y.train ~", paste0("1+",paste(colnames(X2.train), collapse = "+")),"+(1+",paste(colnames(X2.train), collapse = "+"),"|title)"))

model2_fit_hier_title <- stan_glmer(formula = formula2,
                              data = df2.train, 
                              cores=4,
                              adapt_delta = 0.98,
                              algorithm = "sampling",
                              family = binomial(link = "logit"),
                              prior = student_t(7,0,2.5),
                              prior_intercept = student_t(7,0,2.5))

# model 2: hierarchical grouped by passenger class----------------------------------------------------------------
formula3 <- as.formula(paste("y.train ~", paste0("1+",paste(colnames(X3.train), collapse = "+")),"+(1+",paste(colnames(X3.train), collapse = "+"),"|pClass)"))

model3_fit_hier_pClass <- stan_glmer(formula = formula3,
                              data = df3.train, 
                              cores=4,
                              adapt_delta = 0.98,
                              algorithm = "sampling",
                              family = binomial(link = "logit"),
                              prior = student_t(7,0,2.5),
                              prior_intercept = student_t(7,0,2.5))

```

```{r model diagnostics}
summary(model1_fit_hier_ticket)
prior_summary(object = model1_fit_hier_ticket)
prior_summary(object = model2_fit_hier_title)
prior_summary(object = model3_fit_hier_pClass)

y_pred1.hier <- posterior_predict(model1_fit_hier_ticket, df1.test)
y_pred2.hier <- posterior_predict(model2_fit_hier_title, df2.test)
y_pred3.hier <- posterior_predict(model3_fit_hier_pClass, df3.test)
yrep1 <- posterior_predict(model1_fit_hier_ticket)
yrep2 <- posterior_predict(model2_fit_hier_title)
yrep3 <- posterior_predict(model3_fit_hier_pClass)

loo1.pred.hier <- loo(model1_fit_hier_ticket)
loo2.pred.hier <- loo(model2_fit_hier_title)
loo3.pred.hier <- loo(model3_fit_hier_pClass)

loo_compare(loo1.pred.hier,loo2.pred.hier,loo3.pred.hier)

ppc_dens_overlay(y.train, yrep1)
ppc_dens_overlay(y.train, yrep2)
ppc_dens_overlay(y.train, yrep3)

mcmc_areas(as.matrix(model1_fit_hier_ticket)[,1:19])
mcmc_areas(as.matrix(model2_fit_hier_ticket)[,1:22])
```

## 5 - Posterior Predictive Checking

## 6 - Model Comparison

## 7 - Prediction Submission
```{r predictions model1}
probs1.hier <- apply(y_pred1.hier, 2, mean)
preds1.hier <- ifelse(probs1.hier > .5, 1, 0)

probs2.hier <- apply(y_pred2.hier, 2, mean)
preds2.hier <- ifelse(probs2.hier > .5, 1, 0)

probs3.hier <- apply(y_pred3.hier, 2, mean)
preds3.hier <- ifelse(probs3.hier > .5, 1, 0)

model1_hier.submission <- data.frame("PassengerId" = pId.test, "Survived" = preds1.hier)
write.csv(x = model1_hier.submission, file = file.path("C:","Users","Alp","Dropbox","Data Science",                                             "Bayesian Data Analysis","BDA3 (Gelman)","titanic","submissions","model1_hier_ticket.csv"),
          row.names = FALSE)

model2_hier.submission <- data.frame("PassengerId" = pId.test, "Survived" = preds2.hier)
write.csv(x = model2_hier.submission, file = file.path("C:","Users","Alp","Dropbox","Data Science",                                             "Bayesian Data Analysis","BDA3 (Gelman)","titanic","submissions","model2_hier_title.csv"),
          row.names = FALSE)

model3_hier.submission <- data.frame("PassengerId" = pId.test, "Survived" = preds3.hier)
write.csv(x = model3_hier.submission, file = file.path("C:","Users","Alp","Dropbox","Data Science",                                             "Bayesian Data Analysis","BDA3 (Gelman)","titanic","submissions","model3_hier_pClass.csv"),
          row.names = FALSE)
```
